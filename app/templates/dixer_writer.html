{% extends "base.html" %}

{% block title %}Dixer Writer - CollinsGPT{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" class="text-decoration-none">Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Dixer Writer</li>
        </ol>
    </nav>
    <div class="d-flex align-items-center">
        <div class="rounded bg-labor-light d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
            <i class="bi bi-mic-fill fs-4 text-labor"></i>
        </div>
        <div>
            <h1 class="h3 fw-bold text-dark mb-0">Question Time Dixer Writer</h1>
            <p class="text-muted mb-0">Generate parliamentary questions and ministerial answers</p>
        </div>
    </div>
</div>

<!-- Error Alert -->
<div id="error-alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span id="error-message"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="row">
    <!-- Input Form -->
    <div class="col-lg-5 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-semibold">
                    <i class="bi bi-pencil-square me-2 text-labor"></i>Input Details
                </h5>
            </div>
            <div class="card-body p-4">
                <form id="dixer-form">
                    <!-- Answer Word Count -->
                    <div class="mb-4">
                        <label for="word_count" class="form-label fw-semibold">
                            Answer Length: <span id="word-count-value" class="text-labor">{{ form_data.word_count }}</span> words
                        </label>
                        <input
                            type="range"
                            class="form-range"
                            id="word_count"
                            name="word_count"
                            min="100"
                            max="400"
                            step="25"
                            value="{{ form_data.word_count }}">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">100</small>
                            <small class="text-muted">250</small>
                            <small class="text-muted">400</small>
                        </div>
                        <div class="form-text">Target word count for the Minister's answer.</div>
                    </div>

                    <!-- Topic/Announcement -->
                    <div class="mb-4">
                        <label for="topic" class="form-label fw-semibold">
                            Topic / Announcement <span class="text-danger">*</span>
                        </label>
                        <textarea
                            class="form-control"
                            id="topic"
                            name="topic"
                            rows="4"
                            placeholder="Enter the core policy, funding announcement, or news story..."
                            required>{{ form_data.topic }}</textarea>
                        <div class="form-text">The main subject the question will be about.</div>
                    </div>

                    <!-- Member Asking -->
                    <div class="mb-4">
                        <label for="member_name" class="form-label fw-semibold">
                            Member Asking <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            id="member_name"
                            name="member_name"
                            placeholder="e.g., Ms Sharon Claydon"
                            value="{{ form_data.member_name }}">
                        <div class="form-text">Leave blank if unknown - a placeholder will be used.</div>
                    </div>

                    <!-- Member's Electorate -->
                    <div class="mb-4">
                        <label for="electorate" class="form-label fw-semibold">
                            Member's Electorate <span class="text-muted fw-normal">(optional)</span>
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            id="electorate"
                            name="electorate"
                            placeholder="e.g., Newcastle"
                            value="{{ form_data.electorate }}">
                        <div class="form-text">Leave blank if unknown - a placeholder will be used.</div>
                    </div>

                    <!-- Strategy -->
                    <div class="mb-4">
                        <label for="strategy" class="form-label fw-semibold">
                            Strategy <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="strategy" name="strategy" required>
                            <option value="option_a" {% if form_data.strategy == 'option_a' %}selected{% endif %}>
                                Option A: Good News (Positive)
                            </option>
                            <option value="option_b" {% if form_data.strategy == 'option_b' %}selected{% endif %}>
                                Option B: Contrast (Attack)
                            </option>
                        </select>
                        <div class="form-text">
                            <strong>Option A:</strong> Highlight positive government action.<br>
                            <strong>Option B:</strong> Contrast with Opposition failures.
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-btn" class="btn btn-labor w-100 py-2">
                        <span id="btn-text"><i class="bi bi-magic me-2"></i>Generate Dixer</span>
                        <span id="btn-loading" class="d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Generating...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Output Section -->
    <div class="col-lg-7 mb-4">
        <!-- Loading State -->
        <div id="loading-state" class="d-none">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="spinner-grow spinner-grow-sm text-labor me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="fw-semibold text-muted">Generating your dixer...</span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-labor" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- Streaming Output Preview -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-braces me-2"></i>Raw Output
                    </h5>
                    <small class="opacity-75">Streaming response...</small>
                </div>
                <div class="card-body p-4">
                    <div id="stream-output" class="stream-output" style="white-space: pre-line; font-family: inherit; min-height: 200px;"></div>
                    <span id="cursor" class="typing-cursor">|</span>
                </div>
            </div>
        </div>

        <!-- Result State -->
        <div id="result-state" class="d-none">
            <!-- Question Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-labor text-white py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-chat-left-quote-fill me-2"></i>The Question
                    </h5>
                    <small class="opacity-75">For the Backbencher to ask</small>
                </div>
                <div class="card-body p-4">
                    <div id="question-text" class="question-text" style="white-space: pre-line;"></div>
                    <hr class="my-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('question')">
                        <i class="bi bi-clipboard me-1"></i>Copy Question
                    </button>
                </div>
            </div>

            <!-- Answer Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0 fw-semibold">
                        <i class="bi bi-chat-right-quote-fill me-2"></i>The Answer
                    </h5>
                    <small class="opacity-75">Minister Collins' Response</small>
                </div>
                <div class="card-body p-4">
                    <div id="answer-text" class="answer-text" style="white-space: pre-line;"></div>
                    <hr class="my-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('answer')">
                        <i class="bi bi-clipboard me-1"></i>Copy Answer
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-5" style="min-height: 400px;">
                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mb-4" style="width: 80px; height: 80px;">
                    <i class="bi bi-chat-square-text fs-1 text-muted"></i>
                </div>
                <h5 class="text-muted fw-semibold">No Output Yet</h5>
                <p class="text-muted mb-0">Fill in the form and click "Generate Dixer" to create a parliamentary question and answer.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('dixer-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    const emptyState = document.getElementById('empty-state');
    const loadingState = document.getElementById('loading-state');
    const resultState = document.getElementById('result-state');
    const streamOutput = document.getElementById('stream-output');
    const cursor = document.getElementById('cursor');
    const errorAlert = document.getElementById('error-alert');
    const errorMessage = document.getElementById('error-message');
    const wordCountSlider = document.getElementById('word_count');
    const wordCountValue = document.getElementById('word-count-value');

    // Update word count display
    wordCountSlider.addEventListener('input', (e) => {
        wordCountValue.textContent = e.target.value;
    });

    // Cursor blink animation
    setInterval(() => {
        if (cursor) cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
    }, 530);

    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
    }

    function hideError() {
        errorAlert.classList.add('d-none');
    }

    function setLoading(isLoading) {
        if (isLoading) {
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            submitBtn.disabled = true;
            emptyState.classList.add('d-none');
            resultState.classList.add('d-none');
            loadingState.classList.remove('d-none');
            streamOutput.textContent = '';
            cursor.classList.remove('d-none');
        } else {
            btnText.classList.remove('d-none');
            btnLoading.classList.add('d-none');
            submitBtn.disabled = false;
            cursor.classList.add('d-none');
        }
    }

    function showResult(question, answer) {
        loadingState.classList.add('d-none');
        resultState.classList.remove('d-none');
        document.getElementById('question-text').textContent = question;
        document.getElementById('answer-text').textContent = answer;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();
        setLoading(true);

        const formData = {
            word_count: parseInt(document.getElementById('word_count').value),
            topic: document.getElementById('topic').value,
            member_name: document.getElementById('member_name').value,
            electorate: document.getElementById('electorate').value,
            strategy: document.getElementById('strategy').value
        };

        try {
            const response = await fetch('{{ url_for("main.dixer_writer_stream") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.error) {
                                setLoading(false);
                                emptyState.classList.remove('d-none');
                                loadingState.classList.add('d-none');
                                showError(data.error);
                                return;
                            }

                            if (data.chunk) {
                                streamOutput.textContent += data.chunk;
                                // Auto-scroll to bottom
                                streamOutput.scrollTop = streamOutput.scrollHeight;
                            }

                            if (data.done) {
                                setLoading(false);
                                showResult(data.question, data.answer);
                            }
                        } catch (parseError) {
                            console.error('Parse error:', parseError);
                        }
                    }
                }
            }
        } catch (error) {
            setLoading(false);
            emptyState.classList.remove('d-none');
            loadingState.classList.add('d-none');
            showError('Network error: ' + error.message);
        }
    });

    function copyToClipboard(type) {
        const textElement = document.getElementById(type === 'question' ? 'question-text' : 'answer-text');
        const text = textElement.innerText;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!', 'success');
        }).catch(err => {
            showToast('Failed to copy text', 'danger');
        });
    }
</script>
{% endblock %}
